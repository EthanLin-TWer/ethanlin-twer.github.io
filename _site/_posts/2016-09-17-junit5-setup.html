<p>2015年11月，<a href="http://junit.org/junit4/junit-lambda.html">Junit Lambda</a> 团队发布了该项目的 <a href="http://blog.codefx.org/libraries/junit-lambda-prototype/">第一版原型</a> 。此后，该项目把名称改成了 JUnit 5 并独立了出来，随后在2016年2月份的时候发布了一个 alpha 版本。本篇打算以一系列文章，简短地探索一下以下几个方面：</p>

<blockquote>
  <p>原文地址：<a href="http://blog.codefx.org/libraries/junit-5-setup/">http://blog.codefx.org/libraries/junit-5-setup/</a><br />
原文日期：15, Feb, 2016<br />
译文首发：<a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-setup"> Linesh 的博客：「译」JUnit 5 系列：环境搭建</a><br />
我的 Github：<a href="http://github.com/linesh-simplicity">http://github.com/linesh-simplicity</a></p>
</blockquote>

<ul>
  <li><a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-setup">环境搭建</a></li>
  <li><a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-basics">基础入门</a></li>
  <li><a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-architecture">架构体系</a></li>
  <li><a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-extension-model">扩展模型（Extension Model)</a></li>
  <li><a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-conditions">条件断言</a></li>
  <li>注入</li>
  <li><a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-dynamic-tests">动态测试</a></li>
  <li>…</li>
</ul>

<p>（如果不喜欢看文章，你可以<a href="http://blog.codefx.org/past-talks/">戳这里看我的演讲</a>，或者<a href="https://www.youtube.com/watch?v=ct9sIsrnE9Y">看一下最近的 vJUG 讲座</a>，或者<a href="https://www.youtube.com/watch?v=oG80XZUN1lQ">我在 DevoxxPL 上的 PPT</a>。</p>

<p>本篇将介绍 JUnit 5 的环境搭建，看完之后你应该能够使用新的 API 来撰写测试，并且使用你喜欢的 IDE 或构建工具来跑这些测试了。</p>

<h2 id="概述">概述</h2>

<p>本系列文章都基于 Junit 5发布的先行版 <a href="http://junit.org/junit5/docs/5.0.0-M2/user-guide/">Milestone 2</a>。它可能会有变化。如果有新的里程碑（milestone）版本发布，或者试用版正式发行时，我会再来更新这篇文章。</p>

<p>这里要介绍的多数知识你都可以在 <a href="http://junit.org/junit5/docs/5.0.0-M2/user-guide/">JUnit 5 用户指南</a> 中找到（这个链接指向的是先行版 Milestone 2，想看的最新版本文档的话请戳<a href="http://junit.org/junit5/docs/current/user-guide/">这里</a>），并且指南还有更多的内容等待你发掘。下面的所有代码都可以在 <a href="https://github.com/CodeFX-org/demo-junit-5">我的 Github</a> 上找到。</p>

<h2 id="目录">目录</h2>

<ul>
  <li>第一个测试</li>
  <li>运行测试
    <ul>
      <li>使用 JUnit 4 runner</li>
      <li>IDE 的支持</li>
      <li>构建工具的支持</li>
      <li>命令行支持也不赖</li>
    </ul>
  </li>
  <li>向下兼容性</li>
  <li>回顾</li>
  <li>分享&amp;关注</li>
</ul>

<h2 id="第一个测试">第一个测试</h2>

<p>支持测试撰写的 API 包含在<code class="highlighter-rouge"> junit-jupiter-api</code> 包中。在构建工具中引入这个包，就行了。这就是全部，你就可以开始写测试了。</p>

<ul>
  <li>Group ID: <code class="highlighter-rouge">org.junit.jupiter</code></li>
  <li>Artifact ID: <code class="highlighter-rouge">junit-jupiter-api</code></li>
  <li>Version: <code class="highlighter-rouge">5.0.0-M2</code></li>
</ul>

<p>我们来写<a href="https://github.com/CodeFX-org/demo-junit-5/blob/master/src/test/java/org/codefx/demo/junit5/HelloWorldTest.java">第一个测试</a>吧，此处简单最好：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">codefx</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">junit5</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
 
<span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="o">{</span>
 
	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">helloJUnit5</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello, JUnit 5."</span><span class="o">);</span>
	<span class="o">}</span>
 
<span class="o">}</span>
</code></pre></div></div>

<p>看起来怎样？没 <code class="highlighter-rouge">public</code> ，感觉帅气不？这里我不会太深入细节讲解，不过<a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-basics">下一篇</a>我会深入讨论下这个（以及其他的一些基础）。请别急，接着往下看。</p>

<h2 id="运行测试">运行测试</h2>

<p>JUnit 5 是一代全新的测试框架，不过工具内置的支持则还未完全跟上。好在目前已有简易的方法来运行 JUnit 5 及其测试。</p>

<h3 id="使用-junit-4-runner">使用 JUnit 4 runner</h3>

<p>JUnit 团队提供了一个 <code class="highlighter-rouge">JunitPlatform</code> <a href="http://www.codeaffine.com/2014/09/03/junit-nutshell-test-runners/">runner</a>，可以使用它在 Junit 4 上运行 JUnit 5 的测试。这个 runner 在另一个包下，因此你也必须将它加入到你的项目中：</p>

<ul>
  <li>Group ID: <code class="highlighter-rouge">org.junit.platform</code></li>
  <li>Artifact ID: <code class="highlighter-rouge">junit-platform-runner</code></li>
  <li>Version: <code class="highlighter-rouge">1.0.0-M2</code></li>
</ul>

<p>这个 runner 最终会调用 Junit 引擎，后者才是真正运行 Junit 5 测试的部分。引擎也是在不同的包下，你也必须将它加入到项目中：</p>

<ul>
  <li>Group ID: <code class="highlighter-rouge">org.junit.jupiter</code></li>
  <li>Artifact ID: <code class="highlighter-rouge">junit-jupiter-engine</code></li>
  <li>Version: <code class="highlighter-rouge">5.0.0-M2</code></li>
</ul>

<p>要运行项目中所有的测试，为它们创建一个测试套件是最简单的做法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">codefx</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">junit5</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">org.junit.platform.runner.JUnitPlatform</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.platform.runner.SelectPackages</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
 
<span class="nd">@RunWith</span><span class="o">(</span><span class="nc">JUnitPlatform</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SelectPackages</span><span class="o">({</span> <span class="s">"org.codefx.demo.junit5"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestWithJUnit5</span> <span class="o">{</span> <span class="o">}</span>
</code></pre></div></div>

<p>不过请注意，这个类必须是一个 JUnit 4 的测试类，也即是说它必须遵循 <a href="http://stackoverflow.com/a/6178629/2525313">一般的命名规范</a>，并且必须是 <code class="highlighter-rouge">public</code> 的。<code class="highlighter-rouge">@SelectPackages</code> 注解会把包当做一个有层级的结构，因此它会负责跑 <code class="highlighter-rouge">org.codefx.demo.junit5</code> 开头的包下的所有测试。</p>

<p>至此所有工作都完成了！你的 IDE 和构建工具应该都能运行这个 <code class="highlighter-rouge">@RunWith(JUnitPlatform.class)</code> 注解的测试类了，它会负责跑所有的 JUnit 5 的新测试。</p>

<p>不过在 JUnit 5 被完全支持之前，一些特性可能还不能工作，比如 IDE 无法运行单独的测试等。不过目前为止，这是我发现的最简单并且在多平台下均工作良好的方案了。</p>

<h3 id="ide-的支持">IDE 的支持</h3>

<p>Intellij IDEA <a href="https://blog.jetbrains.com/idea/2016/07/intellij-idea-2016-2-is-here/">2016.2</a> 开始 <a href="https://blog.jetbrains.com/idea/2016/08/using-junit-5-in-intellij-idea">对 JUnit 5 有了基本的支持</a>。尽管支持还不是很完美，并且还需时刻关注 JUnit 5 的发展，不过毕竟最基本的支持有了，现在使用 JUnit 5 已经简单得多了。</p>

<p>Eclipse 方面团队 <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=488566">仍在着手于内置支持的开发</a>。</p>

<h3 id="构建工具的支持">构建工具的支持</h3>

<p>JUnit 团队在为构建工具提供 JUnit 5 支持的基础上已经做了大量的工作，比如提供与 JUnit 4 的兼容等。目前，我们已经有了一个可以工作的 Gradle 插件和 Maven Surefire 插件。这两个项目都计划在接下来的时间里交给各自的社区去开发和维护。</p>

<p>在如何集成这两个构建工具（<a href="https://github.com/junit-team/junit5-samples/blob/master/junit5-gradle-consumer">Gradle</a>和<a href="https://github.com/junit-team/junit5-samples/tree/master/junit5-maven-consumer">Maven</a>）的插件上，已经各有一个示例代码库。更多细节请前往 <a href="http://junit.org/junit5/docs/5.0.0-M1/user-guide/#running-tests-build">官方用户指南</a> 。</p>

<h3 id="命令行支持也不赖">命令行支持也不赖</h3>

<p>如果你觉得你就想静静地跑个测试，上面介绍的 IDE 和构建工具都太复杂了，那么建议你试下这个 <a href="http://junit.org/junit5/docs/5.0.0-M1/user-guide/#running-tests-console-launcher">控制台 launcher</a>，它支持你直接在命令行运行测试。要使用它，请 <a href="https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console/1.0.0-M2/junit-platform-console-1.0.0-M2.zip">下载这个 zip 包</a>。</p>

<p>遗憾的是，它 <a href="https://github.com/junit-team/junit5/issues/155">还需要你做些配置</a>，而非拿来即用的。你需要将上面提到的两个包 <code class="highlighter-rouge">junit-jupiter-api</code> 和 <code class="highlighter-rouge">junit-jupiter-engine</code> 移动到 <code class="highlighter-rouge">lib</code> 目录下，并编辑 <code class="highlighter-rouge">bin</code> 下执行脚本的 classpath 使其指向你的 <code class="highlighter-rouge">lib</code> 目录：<code class="highlighter-rouge">CLASSPATH=$APP_HOEM/lib/*</code>。这样该 launcher 才能运行。</p>

<p>不考虑其他依赖的话，这个执行脚本大概长得像这样：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># run all tests</span>
junit-platform-console <span class="nt">-p</span> <span class="k">${</span><span class="nv">path_to_compiled_test_classes</span><span class="k">}</span> <span class="nt">-a</span>
<span class="c"># run a specific test</span>
junit-platform-console
	<span class="nt">-p</span> <span class="k">${</span><span class="nv">path_to_compiled_test_classes</span><span class="k">}</span>
	org.codefx.demo.junit5.HelloWorldTest
</code></pre></div></div>

<h2 id="向下兼容性">向下兼容性</h2>

<p>你可能注意到了，JUnit 5 启用了新的包名：<code class="highlighter-rouge">org.junit.jupiter</code>、<code class="highlighter-rouge">org.junit.platform</code> 和 <code class="highlighter-rouge">org.junit.vintage</code> （这个包我们尚未谈到）。我们<a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-architecture">待会</a>再讨论它们的含义，现在我们只需知道，这意味着你可以在一个项目中使用不同的 JUnit 版本，这就够了。</p>

<p>允许在同个项目中使用多个版本的 JUnit 来进行测试，这使得你能缓缓迁移到 JUnit 5上。关于迁移，我们在探讨 <a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-architecture">JUnit 新的架构</a> 时会再回顾这个话题。</p>

<p>通过异常（exceptions）于 JUnit 交互的测试库，诸如 Hamcrest 和 AssertJ 等，易燃可以在 JUnit 的新版本下工作。这里有个使用 Mockito 和 AssertJ 写的 <a href="https://github.com/CodeFX-org/demo-junit-5/blob/master/src/test/java/org/codefx/demo/junit5/HelloWorldTest.java"><code class="highlighter-rouge">HelloWorldTest</code></a> 测试，有兴趣的同学可以看下。</p>

<h2 id="回顾">回顾</h2>

<p>在这篇 JUnit 5 环境搭建的文章中，我们介绍了 <code class="highlighter-rouge">junit-jupiter-api</code> 和 <code class="highlighter-rouge">junit-jupiter-engine</code> 两个包，在项目中使用了 <code class="highlighter-rouge">junit-platform-runner</code> ，写了第一个最简单的测试用例，并将它作为 JUnit 4 测试套件的一部分运行了起来。</p>

<p><a href="http://blog.linesh.tw/#/posts/2016-09-17-junit5-basics">下篇文章</a> 我会讨论使用 JUnit 5 撰写测试的一些基础知识。</p>

